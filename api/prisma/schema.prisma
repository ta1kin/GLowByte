generator client {
    provider = "prisma-client-js"
    engineType = "node" 
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// ============================================
// Пользователи и аутентификация
// ============================================

enum Role {
    OPERATOR // Оператор склада
    ENGINEER // Инженер
    ADMIN // Администратор
    ANALYST // Аналитик
}

enum UserStatus {
    ACTIVE
    INACTIVE
    BLOCKED
}

model User {
    id         Int        @id @default(autoincrement())
    telegramId String     @unique // Telegram ID пользователя
    username   String? // Telegram username
    firstName  String? // Имя из Telegram
    lastName   String? // Фамилия из Telegram
    fullName   String? // Полное имя
    role       Role       @default(OPERATOR)
    status     UserStatus @default(ACTIVE)
    lang       String     @default("ru") // Язык интерфейса
    phone      String? // Телефон (опционально)
    email      String? // Email (опционально)

    // Связи
    uploads       Upload[]
    auditLogs     AuditLog[]
    notifications Notification[]
    userSettings  UserSettings?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([telegramId])
    @@index([role])
}

// Настройки пользователя
model UserSettings {
    id     Int  @id @default(autoincrement())
    userId Int  @unique
    user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

    // Настройки уведомлений
    notifyCritical Boolean @default(true) // Уведомления о критических рисках
    notifyHigh     Boolean @default(true) // Уведомления о высоких рисках
    notifyMedium   Boolean @default(false) // Уведомления о средних рисках
    notifyLow      Boolean @default(false) // Уведомления о низких рисках

    // Настройки отображения
    defaultSkladId Int? // Склад по умолчанию
    defaultView    String @default("dashboard") // dashboard | calendar | analytics

    // Настройки прогнозов
    predictionHorizon Int @default(7) // Горизонт прогнозирования (дни)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

// ============================================
// Загрузка данных
// ============================================

enum UploadStatus {
    PENDING // Ожидает обработки
    PROCESSING // В процессе обработки
    COMPLETED // Успешно обработан
    FAILED // Ошибка обработки
    PARTIAL // Частично обработан (с ошибками)
}

enum FileType {
    SUPPLIES // supplies.csv
    FIRES // fires.csv
    TEMPERATURE // temperature.csv
    WEATHER // weather.csv
}

model Upload {
    id            Int          @id @default(autoincrement())
    filename      String // Имя файла
    fileType      FileType // Тип файла
    uploadedBy    Int? // ID пользователя
    user          User?        @relation(fields: [uploadedBy], references: [id])
    status        UploadStatus @default(PENDING)
    rowsTotal     Int? // Всего строк в файле
    rowsProcessed Int? // Обработано строк
    rowsFailed    Int? // Строк с ошибками
    errors        Json? // Детали ошибок
    metadata      Json? // Дополнительные метаданные
    createdAt     DateTime     @default(now())
    updatedAt     DateTime     @updatedAt

    @@index([fileType, status])
    @@index([uploadedBy])
}

// ============================================
// Склады и штабели
// ============================================

model Sklad {
    id          Int     @id @default(autoincrement())
    number      Int     @unique // Номер склада (из CSV)
    name        String? // Название склада
    locationRaw String? // Описание местоположения (без точных координат)
    description String? // Дополнительное описание

    // Связи
    shtabels    Shtabel[]
    fires       FireRecord[]
    temps       TempRecord[]
    supplies    Supply[]
    predictions Prediction[]

    createdAt      DateTime        @default(now())
    updatedAt      DateTime        @updatedAt
    featureVectors FeatureVector[]

    @@index([number])
}

enum ShtabelStatus {
    ACTIVE // Активный штабель
    SHIPPED // Отгружен
    FIRED // Сгорел
    ARCHIVED // Архивирован
}

model Shtabel {
    id      Int     @id @default(autoincrement())
    skladId Int
    sklad   Sklad   @relation(fields: [skladId], references: [id])
    label   String // Номер/код штабеля
    mark    String? // Марка угля (A1, B2, E5 и т.д.)

    // Физические параметры
    formedAt DateTime? // Дата начала формирования
    height_m Float? // Высота (метры)
    width_m  Float? // Ширина (метры)
    length_m Float? // Длина (метры)
    mass_t   Float? // Масса (тонны)

    // Текущее состояние
    status       ShtabelStatus @default(ACTIVE)
    currentMass  Float? // Текущая масса
    lastTemp     Float? // Последняя зафиксированная температура
    lastTempDate DateTime? // Дата последнего измерения температуры

    // Связи
    supplies       Supply[]
    temps          TempRecord[]
    predictions    Prediction[]
    fires          FireRecord[]
    featureVectors FeatureVector[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([skladId, label])
    @@index([skladId, status])
    @@index([mark])
    @@index([status])
}

// ============================================
// Данные о поставках (supplies.csv)
// ============================================

model Supply {
    id        Int     @id @default(autoincrement())
    skladId   Int
    sklad     Sklad   @relation(fields: [skladId], references: [id])
    shtabelId Int
    shtabel   Shtabel @relation(fields: [shtabelId], references: [id])

    // Данные из CSV
    dateIn      DateTime  @db.Timestamptz // ВыгрузкаНаСклад
    mark        String? // Наим. ЕТСНГ (марка угля)
    dateShip    DateTime? @db.Timestamptz // ПогрузкаНаСудно
    toStorage_t Float? // На склад, тн
    toShip_t    Float? // На судно, тн

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([skladId, dateIn])
    @@index([shtabelId])
    @@index([mark])
    @@index([dateIn])
}

// ============================================
// Данные о самовозгораниях (fires.csv)
// ============================================

model FireRecord {
    id        Int      @id @default(autoincrement())
    skladId   Int
    sklad     Sklad    @relation(fields: [skladId], references: [id])
    shtabelId Int?
    shtabel   Shtabel? @relation(fields: [shtabelId], references: [id])

    // Данные из CSV
    reportDate DateTime  @db.Timestamptz // Дата составления
    mark       String? // Груз (марка угля)
    weight_t   Float? // Вес по акту, тн
    startDate  DateTime  @db.Timestamptz // Дата начала
    endDate    DateTime? @db.Timestamptz // Дата окончания
    formedAt   DateTime? // Нач.форм.штабеля

    // Дополнительные данные
    duration_hours Float? // Длительность в часах (вычисляемое)
    damage_t       Float? // Ущерб в тоннах

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([skladId, startDate])
    @@index([shtabelId])
    @@index([startDate])
    @@index([mark])
}

// ============================================
// Температурные данные (temperature.csv)
// ============================================

model TempRecord {
    id        Int     @id @default(autoincrement())
    skladId   Int
    sklad     Sklad   @relation(fields: [skladId], references: [id])
    shtabelId Int
    shtabel   Shtabel @relation(fields: [shtabelId], references: [id])

    // Данные из CSV
    mark       String? // Марка угля
    maxTemp    Float // Максимальная температура
    piket      String? // Пикет (локация измерения)
    recordDate DateTime @db.Timestamptz // Дата акта
    shift      Float? // Смена

    // Дополнительные данные
    riskLevel String? // Уровень риска (LOW, MEDIUM, HIGH, CRITICAL)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([shtabelId, recordDate])
    @@index([skladId, recordDate])
    @@index([recordDate])
    @@index([maxTemp])
}

// ============================================
// Метеоданные (weather.csv)
// ============================================

model Weather {
    id Int      @id @default(autoincrement())
    ts DateTime @unique @db.Timestamptz // date (временная метка)

    // Данные из CSV
    t             Float? // Температура воздуха
    p             Float? // Атмосферное давление
    humidity      Float? // Влажность
    precipitation Float? // Осадки
    wind_dir      Int? // Направление ветра
    v_avg         Float? // Средняя скорость ветра
    v_max         Float? // Максимальная скорость ветра
    cloudcover    Float? // Облачность
    visibility    Float? // Видимость
    weather_code  Int? // Код погоды

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([ts])
}

// ============================================
// Feature Store (векторы признаков)
// ============================================

model FeatureVector {
    id        Int      @id @default(autoincrement())
    ts        DateTime @db.Timestamptz // Временная метка расчета признаков
    skladId   Int
    sklad     Sklad    @relation(fields: [skladId], references: [id])
    shtabelId Int
    shtabel   Shtabel  @relation(fields: [shtabelId], references: [id])

    // Признаки для ML модели
    features Json // Сериализованный набор признаков

    // Метаданные
    modelVersion String? // Версия модели, для которой были рассчитаны признаки
    createdAt    DateTime @default(now())

    @@index([shtabelId, ts])
    @@index([skladId, ts])
}

// ============================================
// Прогнозы самовозгорания
// ============================================

enum RiskLevel {
    LOW // Низкий риск
    MEDIUM // Средний риск
    HIGH // Высокий риск
    CRITICAL // Критический риск
}

model Prediction {
    id        Int      @id @default(autoincrement())
    ts        DateTime @db.Timestamptz // Временная метка прогноза
    skladId   Int
    sklad     Sklad    @relation(fields: [skladId], references: [id])
    shtabelId Int
    shtabel   Shtabel  @relation(fields: [shtabelId], references: [id])

    // Модель
    modelName    String // Название модели (например, "xgboost_v1")
    modelVersion String? // Версия модели

    // Прогноз
    predictedDate DateTime? @db.Timestamptz // Прогнозируемая дата возгорания
    probEvent     Float? // Вероятность события в горизонте (0-1)
    riskLevel     RiskLevel // Уровень риска
    horizonDays   Int       @default(7) // Горизонт прогнозирования (дни)

    // Доверительный интервал
    intervalLow  DateTime? @db.Timestamptz // Нижняя граница интервала
    intervalHigh DateTime? @db.Timestamptz // Верхняя граница интервала
    confidence   Float? // Уверенность модели (0-1)

    // Оценка точности (заполняется после фактического возгорания)
    actualFireDate DateTime? @db.Timestamptz // Фактическая дата возгорания
    accuracy_days  Float? // Точность прогноза (разница в днях)
    isAccurate     Boolean? // В пределах ±2 дней

    // Метаданные
    meta     Json? // Дополнительные метаданные (использованные признаки, etc.)
    notified Boolean @default(false) // Отправлено ли уведомление

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([shtabelId, ts])
    @@index([skladId, ts])
    @@index([riskLevel])
    @@index([predictedDate])
    @@index([notified])
}

// ============================================
// Модели машинного обучения
// ============================================

enum ModelStatus {
    TRAINING // В процессе обучения
    ACTIVE // Активная модель
    ARCHIVED // Архивирована
    FAILED // Ошибка обучения
}

model ModelArtifact {
    id      Int         @id @default(autoincrement())
    name    String // Название модели
    version String // Версия модели
    status  ModelStatus @default(TRAINING)

    // Хранилище
    path     String // Путь к файлу модели (S3 или локальное хранилище)
    fileSize BigInt? // Размер файла (байты)

    // Метаданные обучения
    trainedAt    DateTime? // Дата обучения
    trainedBy    String? // Кто обучил (система или пользователь)
    trainingData Json? // Информация о данных обучения
    hyperparams  Json? // Гиперпараметры модели

    // Метрики обучения
    trainMetrics Json? // Метрики на обучающей выборке
    valMetrics   Json? // Метрики на валидационной выборке
    testMetrics  Json? // Метрики на тестовой выборке

    // Дополнительные метаданные
    meta Json? // Дополнительные метаданные

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([name, version], name: "name_version")
    @@index([status])
    @@index([trainedAt])
}

// ============================================
// Метрики производительности моделей
// ============================================

model Metric {
    id           Int     @id @default(autoincrement())
    modelName    String
    modelVersion String?

    // Период оценки
    periodStart DateTime
    periodEnd   DateTime

    // Основные метрики
    mae_days           Float? // Mean Absolute Error (дни)
    rmse_days          Float? // Root Mean Square Error (дни)
    mape               Float? // Mean Absolute Percentage Error
    accuracy_within_2d Float? // Точность в пределах ±2 дней (0-1)
    accuracy_within_3d Float? // Точность в пределах ±3 дней (0-1)
    accuracy_within_5d Float? // Точность в пределах ±5 дней (0-1)

    // Дополнительные метрики
    c_index   Float? // Concordance index (для выживаемости)
    precision Float? // Precision (для классификации)
    recall    Float? // Recall (для классификации)
    f1_score  Float? // F1 score

    // Статистика
    totalPredictions Int? // Всего прогнозов
    totalFires       Int? // Всего фактических возгораний
    truePositives    Int? // True Positives
    falsePositives   Int? // False Positives
    falseNegatives   Int? // False Negatives
    trueNegatives    Int? // True Negatives

    // Сырые данные
    raw Json? // Детальные метрики в JSON

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([modelName, periodStart, periodEnd])
    @@index([periodStart])
}

// ============================================
// Уведомления
// ============================================

enum NotificationType {
    CRITICAL_RISK // Критический риск возгорания
    HIGH_RISK // Высокий риск
    PREDICTION_READY // Прогноз готов
    DATA_IMPORTED // Данные импортированы
    MODEL_TRAINED // Модель обучена
    SYSTEM // Системное уведомление
}

enum NotificationStatus {
    PENDING // Ожидает отправки
    SENT // Отправлено
    READ // Прочитано
    FAILED // Ошибка отправки
}

model Notification {
    id     Int  @id @default(autoincrement())
    userId Int
    user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

    type   NotificationType
    status NotificationStatus @default(PENDING)

    title   String // Заголовок уведомления
    message String // Текст уведомления
    data    Json? // Дополнительные данные (ID штабеля, прогноза и т.д.)

    // Связи
    predictionId Int? // Связанный прогноз
    shtabelId    Int? // Связанный штабель
    skladId      Int? // Связанный склад

    // Telegram
    telegramSent  Boolean @default(false) // Отправлено в Telegram
    telegramMsgId Int? // ID сообщения в Telegram

    readAt DateTime? // Когда прочитано
    sentAt DateTime? // Когда отправлено

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([userId, status])
    @@index([type, status])
    @@index([createdAt])
}

// ============================================
// Аудит и логирование
// ============================================

enum AuditAction {
    CREATE
    UPDATE
    DELETE
    VIEW
    EXPORT
    IMPORT
    PREDICT
    TRAIN_MODEL
    LOGIN
    LOGOUT
}

model AuditLog {
    id     Int   @id @default(autoincrement())
    userId Int?
    user   User? @relation(fields: [userId], references: [id])

    action      AuditAction // Действие
    resource    String? // Ресурс (например, "Shtabel", "Prediction")
    resourceId  Int? // ID ресурса
    description String? // Описание действия

    // Данные
    payload   Json? // Данные запроса/ответа
    ipAddress String? // IP адрес
    userAgent String? // User Agent

    // Результат
    success      Boolean @default(true)
    errorMessage String? // Сообщение об ошибке (если есть)

    createdAt DateTime @default(now())

    @@index([userId, createdAt])
    @@index([action, createdAt])
    @@index([resource, resourceId])
    @@index([createdAt])
}

// ============================================
// Системные настройки
// ============================================

model SystemSettings {
    id          Int     @id @default(autoincrement())
    key         String  @unique // Ключ настройки
    value       String // Значение (может быть JSON)
    description String? // Описание настройки
    category    String? // Категория (ML, NOTIFICATIONS, etc.)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([category])
}
