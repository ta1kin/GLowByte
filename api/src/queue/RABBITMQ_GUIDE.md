# –ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ RabbitMQ –≤ –ø—Ä–æ–µ–∫—Ç–µ

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ß—Ç–æ —Ç–∞–∫–æ–µ RabbitMQ –∏ –∑–∞—á–µ–º –æ–Ω –Ω—É–∂–µ–Ω](#—á—Ç–æ-—Ç–∞–∫–æ–µ-rabbitmq)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã –æ—á–µ—Ä–µ–¥–µ–π](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
3. [–ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –æ—á–µ—Ä–µ–¥–∏](#–∫–∞–∫-—Ä–∞–±–æ—Ç–∞—é—Ç-–æ—á–µ—Ä–µ–¥–∏)
4. [–î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞–∂–¥–æ–π –æ—á–µ—Ä–µ–¥–∏](#–æ–ø–∏—Å–∞–Ω–∏–µ-–æ—á–µ—Ä–µ–¥–µ–π)
5. [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#–ø—Ä–∏–º–µ—Ä—ã)
6. [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞](#–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
7. [–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ retry](#–æ–±—Ä–∞–±–æ—Ç–∫–∞-–æ—à–∏–±–æ–∫)
8. [Best practices](#best-practices)

---

## –ß—Ç–æ —Ç–∞–∫–æ–µ RabbitMQ

**RabbitMQ** ‚Äî —ç—Ç–æ –±—Ä–æ–∫–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π (message broker), –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º –æ–±–º–µ–Ω–∏–≤–∞—Ç—å—Å—è –¥–∞–Ω–Ω—ã–º–∏ —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥–∏.

### –ó–∞—á–µ–º –Ω—É–∂–µ–Ω RabbitMQ –≤ –Ω–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ?

1. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—è–∂–µ–ª—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**
   - –ò–º–ø–æ—Ä—Ç –±–æ–ª—å—à–∏—Ö CSV —Ñ–∞–π–ª–æ–≤ (—Ç—ã—Å—è—á–∏ —Å—Ç—Ä–æ–∫)
   - –û–±—É—á–µ–Ω–∏–µ ML –º–æ–¥–µ–ª–µ–π (–º–æ–∂–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å —á–∞—Å—ã)
   - –ú–∞—Å—Å–æ–≤—ã–µ —Ä–∞—Å—á–µ—Ç—ã –ø—Ä–æ–≥–Ω–æ–∑–æ–≤

2. **–†–∞–∑–≥—Ä—É–∑–∫–∞ API**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∂–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏
   - API —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç "–∑–∞–¥–∞—á–∞ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –≤ –æ—á–µ—Ä–µ–¥—å"
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ñ–æ–Ω–µ

3. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**
   - –°–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞ –¥–∏—Å–∫ (persistent)
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
   - Dead Letter Queue –¥–ª—è –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**
   - –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ worker'–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
   - –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   API (NestJS) ‚îÇ
‚îÇ              ‚îÇ
‚îÇ  Controllers ‚îÇ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Services    ‚îÇ   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
                   ‚îÇ Publish
                   ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  RabbitMQ Broker ‚îÇ
         ‚îÇ                  ‚îÇ
         ‚îÇ  Exchange:       ‚îÇ
         ‚îÇ  - coalfire      ‚îÇ
         ‚îÇ  - coalfire.dlx  ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚îÇ Consume
                   ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ   Consumers      ‚îÇ
         ‚îÇ                  ‚îÇ
         ‚îÇ  - DataImport    ‚îÇ
         ‚îÇ  - Prediction    ‚îÇ
         ‚îÇ  - ModelTraining ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ   Processors     ‚îÇ
         ‚îÇ                  ‚îÇ
         ‚îÇ  - ETL Logic     ‚îÇ
         ‚îÇ  - ML Calls      ‚îÇ
         ‚îÇ  - DB Updates    ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Exchange –∏ Routing

**Exchange** ‚Äî —ç—Ç–æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π. –í –Ω–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–∏–ø `direct`:

- `coalfire` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π exchange –¥–ª—è –≤—Å–µ—Ö –∑–∞–¥–∞—á
- `coalfire.dlx` ‚Äî dead letter exchange –¥–ª—è –Ω–µ—É–¥–∞—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

**Routing Key** ‚Äî –∫–ª—é—á –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏, –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤ –∫–∞–∫—É—é –æ—á–µ—Ä–µ–¥—å –ø–æ–ø–∞–¥–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ:

- `data.import` ‚Üí –æ—á–µ—Ä–µ–¥—å `data.import`
- `prediction.calculate` ‚Üí –æ—á–µ—Ä–µ–¥—å `prediction.calculate`
- `prediction.batch` ‚Üí –æ—á–µ—Ä–µ–¥—å `prediction.batch`
- `model.train` ‚Üí –æ—á–µ—Ä–µ–¥—å `model.train`

---

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –æ—á–µ—Ä–µ–¥–∏

### –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —Å–æ–æ–±—â–µ–Ω–∏—è

1. **–ü—É–±–ª–∏–∫–∞—Ü–∏—è (Publish)**

   ```typescript
   // API –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ –∏–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
   await queueService.publish('data.import', {
   	uploadId: 123,
   	filename: 'supplies.csv',
   	fileType: 'SUPPLIES',
   })
   ```

2. **–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è**
   - Exchange –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å routing key `data.import`
   - –ù–∞—Ö–æ–¥–∏—Ç –æ—á–µ—Ä–µ–¥—å `data.import` –ø–æ routing key
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥—å

3. **–û–∂–∏–¥–∞–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥–∏**
   - –°–æ–æ–±—â–µ–Ω–∏–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥–∏ (–Ω–∞ –¥–∏—Å–∫–µ, –µ—Å–ª–∏ persistent)
   - –ñ–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ consumer'–æ–º

4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ (Consume)**
   - Consumer –∑–∞–±–∏—Ä–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –æ—á–µ—Ä–µ–¥–∏
   - –ü–µ—Ä–µ–¥–∞–µ—Ç –≤ Processor –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
   - –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç ACK (acknowledgment)

5. **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ**
   - –ü—Ä–∏ ACK: —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ –æ—á–µ—Ä–µ–¥–∏
   - –ü—Ä–∏ NACK: —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ DLQ

---

## –û–ø–∏—Å–∞–Ω–∏–µ –æ—á–µ—Ä–µ–¥–µ–π

### 1. data.import ‚Äî –ò–º–ø–æ—Ä—Ç CSV —Ñ–∞–π–ª–æ–≤

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±–æ–ª—å—à–∏—Ö CSV —Ñ–∞–π–ª–æ–≤

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**

- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç CSV —á–µ—Ä–µ–∑ API
- –§–∞–π–ª –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç—ã—Å—è—á–∏ —Å—Ç—Ä–æ–∫
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–µ–±—É–µ—Ç –≤—Ä–µ–º–µ–Ω–∏

**–ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö:**

```
1. POST /data/upload ‚Üí DataService.createUpload()
2. –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å Upload –≤ –ë–î (status: PENDING)
3. –°–æ–æ–±—â–µ–Ω–∏–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å
4. DataImportConsumer –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
5. DataImportProcessor:
   - –ß–∏—Ç–∞–µ—Ç CSV —Ñ–∞–π–ª
   - –ü–∞—Ä—Å–∏—Ç –¥–∞–Ω–Ω—ã–µ
   - –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∑–∞–ø–∏—Å–∏
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î (Supplies, Fires, TempRecord, Weather)
   - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å Upload (COMPLETED/PARTIAL/FAILED)
```

**–§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:**

```json
{
	"uploadId": 123,
	"filename": "supplies.csv",
	"fileType": "SUPPLIES"
}
```

**TTL:** 1 —á–∞—Å (–µ—Å–ª–∏ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞ —á–∞—Å ‚Üí –≤ DLQ)

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**

```typescript
// –í DataService
async createUpload(filename: string, fileType: FileType) {
  const upload = await this.prisma.upload.create({
    data: { filename, fileType, status: 'PENDING' }
  });

  // –ü—É–±–ª–∏–∫—É–µ–º –≤ –æ—á–µ—Ä–µ–¥—å - API —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç
  await this.queueService.publish('data.import', {
    uploadId: upload.id,
    filename,
    fileType
  });

  return successResponse(upload, 'Upload queued');
}
```

---

### 2. prediction.calculate ‚Äî –†–∞—Å—á–µ—Ç –æ–¥–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞ —Å–∞–º–æ–≤–æ–∑–≥–æ—Ä–∞–Ω–∏—è –¥–ª—è –æ–¥–Ω–æ–≥–æ —à—Ç–∞–±–µ–ª—è

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**

- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —à—Ç–∞–±–µ–ª—è
- ML Service –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –¥–æ–ª–≥–æ
- –ù–µ –Ω—É–∂–Ω–æ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å API

**–ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö:**

```
1. POST /predictions/:shtabelId ‚Üí PredictionService.createPrediction()
2. –°–æ–æ–±—â–µ–Ω–∏–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å
3. PredictionConsumer –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
4. PredictionProcessor:
   - –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —à—Ç–∞–±–µ–ª—è –∏–∑ –ë–î
   - –í—ã–∑—ã–≤–∞–µ—Ç ML Service –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑ –≤ –ë–î
   - –ï—Å–ª–∏ —Ä–∏—Å–∫ CRITICAL/HIGH ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
```

**–§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:**

```json
{
	"shtabelId": 456
}
```

**TTL:** 30 –º–∏–Ω—É—Ç

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**

```typescript
// –í PredictionService
async createPrediction(shtabelId: number) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —à—Ç–∞–±–µ–ª—è
  const stockpile = await this.prisma.shtabel.findUnique({
    where: { id: shtabelId }
  });

  if (!stockpile) {
    return errorResponse('Stockpile not found');
  }

  // –ü—É–±–ª–∏–∫—É–µ–º –≤ –æ—á–µ—Ä–µ–¥—å
  await this.queueService.publish('prediction.calculate', {
    shtabelId
  });

  return successResponse(
    { shtabelId, queued: true },
    'Prediction queued for processing'
  );
}
```

---

### 3. prediction.batch ‚Äî –ú–∞—Å—Å–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑–æ–≤

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –†–∞—Å—á–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –¥–ª—è –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —à—Ç–∞–±–µ–ª–µ–π

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**

- –ü–ª–∞–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–∞–∑ –≤ –¥–µ–Ω—å)
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç –º–∞—Å—Å–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç
- –ù—É–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ—Ç–Ω–∏ —à—Ç–∞–±–µ–ª–µ–π

**–ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö:**

```
1. POST /predictions/batch/calculate ‚Üí PredictionService.batchPredict()
2. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —à—Ç–∞–±–µ–ª–∏
3. –ü—É–±–ª–∏–∫—É–µ–º –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å–ø–∏—Å–∫–æ–º ID
4. PredictionConsumer –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
5. PredictionProcessor –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–∞–∂–¥—ã–π —à—Ç–∞–±–µ–ª—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
```

**–§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:**

```json
{
  "shtabelIds": [1, 2, 3, 4, 5, ...]
}
```

**TTL:** 1 —á–∞—Å

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**

```typescript
// –í PredictionService
async batchPredict() {
  // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —à—Ç–∞–±–µ–ª–∏
  const stockpiles = await this.prisma.shtabel.findMany({
    where: { status: 'ACTIVE' }
  });

  // –ü—É–±–ª–∏–∫—É–µ–º –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ –≤—Å–µ–º–∏ ID
  await this.queueService.publish('prediction.batch', {
    shtabelIds: stockpiles.map(s => s.id)
  });

  return successResponse(
    { queued: stockpiles.length },
    'Batch predictions queued'
  );
}
```

---

### 4. model.train ‚Äî –û–±—É—á–µ–Ω–∏–µ ML –º–æ–¥–µ–ª–∏

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ ML –º–æ–¥–µ–ª–µ–π

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**

- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
- –û–±—É—á–µ–Ω–∏–µ –º–æ–∂–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å —á–∞—Å—ã
- –ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –º–æ–¥–µ–ª–∏

**–ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö:**

```
1. POST /ml/train ‚Üí MlService.trainModel()
2. –°–æ–æ–±—â–µ–Ω–∏–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å
3. ModelTrainingConsumer –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
4. ModelTrainingProcessor:
   - –°–æ–∑–¥–∞–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å ModelArtifact (status: TRAINING)
   - –í—ã–∑—ã–≤–∞–µ—Ç ML Service /train endpoint
   - –ñ–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—É—á–µ–Ω–∏—è (–º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–ª–≥–æ)
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–æ–¥–µ–ª—å –∏ –º–µ—Ç—Ä–∏–∫–∏ –≤ –ë–î
   - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å (ACTIVE/FAILED)
```

**–§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:**

```json
{
	"modelName": "xgboost_v1",
	"modelVersion": "2.0.0",
	"config": {
		"n_estimators": 100,
		"max_depth": 6,
		"learning_rate": 0.1
	}
}
```

**TTL:** 2 —á–∞—Å–∞

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**

```typescript
// –í MlService
async trainModel(modelName: string, modelVersion: string, config?: any) {
  // –ü—É–±–ª–∏–∫—É–µ–º –≤ –æ—á–µ—Ä–µ–¥—å
  await this.queueService.publish('model.train', {
    modelName,
    modelVersion,
    config: config || {}
  });

  return successResponse(
    { modelName, modelVersion, queued: true },
    'Model training queued'
  );
}
```

---

## –ü—Ä–∏–º–µ—Ä—ã

### –ü—Ä–∏–º–µ—Ä 1: –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª `supplies.csv` —Å 10,000 —Å—Ç—Ä–æ–∫

```typescript
// 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª
POST /data/upload
FormData: { file: supplies.csv, fileType: SUPPLIES }

// 2. API —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –∏ –ø—É–±–ª–∏–∫—É–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å
const upload = await prisma.upload.create({
  data: { filename: 'supplies.csv', fileType: 'SUPPLIES', status: 'PENDING' }
});

await queueService.publish('data.import', {
  uploadId: upload.id,
  filename: 'supplies.csv',
  fileType: 'SUPPLIES'
});

// 3. API —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç (–Ω–µ –∂–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏)
return { success: true, data: upload, message: 'Upload queued' };

// 4. –í —Ñ–æ–Ω–µ Consumer –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:
// - –ß–∏—Ç–∞–µ—Ç —Ñ–∞–π–ª
// - –ü–∞—Ä—Å–∏—Ç 10,000 —Å—Ç—Ä–æ–∫
// - –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ
// - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î
// - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å upload

// 5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å:
GET /data/uploads/123
// Response: { status: 'PROCESSING', rowsProcessed: 5000, rowsTotal: 10000 }
```

### –ü—Ä–∏–º–µ—Ä 2: –†–∞—Å—á–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏

```typescript
// 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑
POST /predictions/456

// 2. API –ø—É–±–ª–∏–∫—É–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å
await queueService.publish('prediction.calculate', { shtabelId: 456 });

// 3. Consumer –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:
const prediction = await mlService.predict(456);
// ML Service –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç: { risk_level: 'CRITICAL', predicted_date: '2024-01-15' }

// 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥–Ω–æ–∑
await prisma.prediction.create({ data: {...} });

// 5. –ï—Å–ª–∏ —Ä–∏—Å–∫ CRITICAL ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
// —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π notifyCritical: true
const users = await prisma.user.findMany({
  where: {
    userSettings: { notifyCritical: true }
  }
});

for (const user of users) {
  await notificationService.createNotification({
    userId: user.id,
    type: 'CRITICAL_RISK',
    title: 'üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫ –≤–æ–∑–≥–æ—Ä–∞–Ω–∏—è',
    message: '–®—Ç–∞–±–µ–ª—å #456 –∏–º–µ–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫ —Å–∞–º–æ–≤–æ–∑–≥–æ—Ä–∞–Ω–∏—è'
  });
}
```

### –ü—Ä–∏–º–µ—Ä 3: –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤

```typescript
// 1. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç –º–∞—Å—Å–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç
POST / predictions / batch / calculate

// 2. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —à—Ç–∞–±–µ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 500 —à—Ç—É–∫)
const stockpiles = await prisma.shtabel.findMany({
	where: { status: 'ACTIVE' },
})

// 3. –ü—É–±–ª–∏–∫—É–µ–º –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
await queueService.publish('prediction.batch', {
	shtabelIds: stockpiles.map(s => s.id), // [1, 2, 3, ..., 500]
})

// 4. Consumer –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
for (const shtabelId of message.shtabelIds) {
	try {
		await predictionProcessor.processPrediction(shtabelId)
		// –ö–∞–∂–¥—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –∑–∞–Ω–∏–º–∞–µ—Ç ~2-5 —Å–µ–∫—É–Ω–¥
		// –í—Å–µ–≥–æ: 500 * 3 = 1500 —Å–µ–∫—É–Ω–¥ = 25 –º–∏–Ω—É—Ç
	} catch (error) {
		// –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–æ —Å–ª–µ–¥—É—é—â–∏–º
	}
}
```

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### RabbitMQ Management UI

–î–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: **http://localhost:15672**

**–õ–æ–≥–∏–Ω:** guest  
**–ü–∞—Ä–æ–ª—å:** guest

### –ß—Ç–æ –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å:

1. **Overview** ‚Äî –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
   - –°–∫–æ—Ä–æ—Å—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏/–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏

2. **Queues** ‚Äî –¥–µ—Ç–∞–ª–∏ –ø–æ –∫–∞–∂–¥–æ–π –æ—á–µ—Ä–µ–¥–∏
   - `data.import` ‚Äî —Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –æ—á–µ—Ä–µ–¥–∏
   - `prediction.calculate` ‚Äî —Å–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏
   - `model.train` ‚Äî –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

3. **Messages** ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
   - –ú–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è
   - –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
   - –ú–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ

### –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:

```typescript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏–º–ø–æ—Ä—Ç–∞
GET /data/uploads/123
// Response –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: rowsProcessed, rowsFailed, status

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏
GET /ml/models
// Response –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: status (TRAINING/ACTIVE/FAILED)

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø—Ä–æ–≥–Ω–æ–∑–æ–≤
GET /predictions?limit=10
```

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ Retry

### –ú–µ—Ö–∞–Ω–∏–∑–º Retry

1. **–ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞** ‚Äî Consumer –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
2. **–û—à–∏–±–∫–∞** ‚Äî –ï—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π
3. **NACK —Å requeue** ‚Äî –°–æ–æ–±—â–µ–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å
4. **Retry —Å—á–µ—Ç—á–∏–∫** ‚Äî –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –≤ headers —Å–æ–æ–±—â–µ–Ω–∏—è
5. **–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞** ‚Äî –î–æ 3 —Ä–∞–∑
6. **–ü–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫** ‚Äî –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ DLQ

### Dead Letter Queue (DLQ)

–ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫, –æ–Ω–æ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ DLQ:

- `data.import.failed`
- `prediction.calculate.failed`
- `prediction.batch.failed`
- `model.train.failed`

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –≤ DLQ:**

1. **–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å** –≤ RabbitMQ Management UI
2. **–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å** –ø—Ä–∏—á–∏–Ω—É –æ—à–∏–±–∫–∏
3. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å** –ø—Ä–æ–±–ª–µ–º—É
4. **–ü–µ—Ä–µ–æ—Ç–ø—Ä–∞–≤–∏—Ç—å** —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ—Å–Ω–æ–≤–Ω—É—é –æ—á–µ—Ä–µ–¥—å

### –ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫:

```typescript
// –í Consumer
await this.queueService.consume('data.import', async (message, msg) => {
  try {
    await this.processor.processImport(message.uploadId, ...);
    this.channel.ack(msg); // –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ
  } catch (error) {
    const retryCount = msg.properties.headers?.['x-retry-count'] || 0;

    if (retryCount < 3) {
      // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –æ—á–µ—Ä–µ–¥—å
      msg.properties.headers = {
        ...msg.properties.headers,
        'x-retry-count': retryCount + 1
      };
      this.channel.nack(msg, false, true); // Requeue
    } else {
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ DLQ
      this.channel.nack(msg, false, false);
      this.logger.error('Message sent to DLQ after 3 retries', ...);
    }
  }
});
```

---

## Best Practices

### 1. –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π

```typescript
// ‚úÖ –•–æ—Ä–æ—à–æ
const stockpile = await prisma.shtabel.findUnique({ where: { id } })
if (!stockpile) {
	return errorResponse('Not found')
}
await queueService.publish('prediction.calculate', { shtabelId: id })

// ‚ùå –ü–ª–æ—Ö–æ
await queueService.publish('prediction.calculate', { shtabelId: id })
// –ï—Å–ª–∏ —à—Ç–∞–±–µ–ª—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, Consumer –ø–æ–ª—É—á–∏—Ç –æ—à–∏–±–∫—É
```

### 2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ idempotency (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)

```typescript
// ‚úÖ –•–æ—Ä–æ—à–æ - –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ–≤—Ç–æ—Ä—è—Ç—å
await prisma.upload.upsert({
  where: { id: uploadId },
  update: { status: 'PROCESSING' },
  create: { id: uploadId, status: 'PROCESSING', ... }
});

// ‚ùå –ü–ª–æ—Ö–æ - –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã
await prisma.upload.create({ data: { ... } });
```

### 3. –õ–æ–≥–∏—Ä—É–π—Ç–µ –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è

```typescript
// ‚úÖ –•–æ—Ä–æ—à–æ
this.logger.log('Processing import', 'DataImportProcessor', {
	uploadId,
	fileType,
	recordCount: records.length,
})

// ‚ùå –ü–ª–æ—Ö–æ
console.log('Processing...') // –ù–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ
```

### 4. –û–±–Ω–æ–≤–ª—è–π—Ç–µ —Å—Ç–∞—Ç—É—Å—ã –≤ –ë–î

```typescript
// ‚úÖ –•–æ—Ä–æ—à–æ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å
await prisma.upload.update({
	where: { id: uploadId },
	data: {
		status: 'PROCESSING',
		rowsProcessed: 100,
		rowsTotal: 1000,
	},
})
```

### 5. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ—à–∏–±–∫–∏ gracefully

```typescript
// ‚úÖ –•–æ—Ä–æ—à–æ
try {
  await this.processor.process(message);
} catch (error) {
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ FAILED
  await this.updateStatus(message.uploadId, 'FAILED', error);
  // –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
  this.logger.error('Processing failed', error.stack, ...);
  // –ü–µ—Ä–µ–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–ª—è retry
  throw error;
}
```

---

## –ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã

### Q: –ö–∞–∫ —É–∑–Ω–∞—Ç—å, –æ–±—Ä–∞–±–æ—Ç–∞–ª–æ—Å—å –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ?

**A:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –≤ –ë–î:

- –î–ª—è –∏–º–ø–æ—Ä—Ç–∞: `GET /data/uploads/:id` ‚Üí —Å–º–æ—Ç—Ä–∏—Ç–µ `status`
- –î–ª—è –ø—Ä–æ–≥–Ω–æ–∑–æ–≤: `GET /predictions` ‚Üí –∏—â–∏—Ç–µ –ø–æ `shtabelId`
- –î–ª—è –º–æ–¥–µ–ª–µ–π: `GET /ml/models` ‚Üí —Å–º–æ—Ç—Ä–∏—Ç–µ `status`

### Q: –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–≤–∏—Å–ª–æ –≤ –æ—á–µ—Ä–µ–¥–∏?

**A:**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Consumer'–æ–≤
2. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –≤ RabbitMQ Management UI
3. –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ "unacked" –¥–æ–ª–≥–æ ‚Üí –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Consumer
4. –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ DLQ ‚Üí –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –∏ –ø–µ—Ä–µ–æ—Ç–ø—Ä–∞–≤—å—Ç–µ

### Q: –ú–æ–∂–Ω–æ –ª–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ?

**A:** –î–∞! –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ API, –∫–∞–∂–¥—ã–π –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –æ—á–µ—Ä–µ–¥–∏. RabbitMQ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç –Ω–∞–≥—Ä—É–∑–∫—É.

### Q: –ö–∞–∫ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç–æ–∫?

**A:** –í `consume()` –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å `prefetch`:

```typescript
await this.channel.prefetch(5) // –ú–∞–∫—Å–∏–º—É–º 5 —Å–æ–æ–±—â–µ–Ω–∏–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
```

### Q: –ö–∞–∫ –æ—Ç–º–µ–Ω–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è?

**A:** –í RabbitMQ Management UI –º–æ–∂–Ω–æ:

- –£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –æ—á–µ—Ä–µ–¥–∏
- –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ –¥—Ä—É–≥—É—é –æ—á–µ—Ä–µ–¥—å
- –ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

RabbitMQ –ø–æ–∑–≤–æ–ª—è–µ—Ç:

- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ç—è–∂–µ–ª—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
- ‚úÖ –ù–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å API
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –∑–∞–Ω—è—Ç—å –±–æ–ª—å—à–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ–∫—É–Ω–¥, –¥–æ–ª–∂–Ω—ã –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥–∏!
